name: ghost
services:

  ghost-server:
    container_name: ghost-server
    image: ghost:6
    restart: always
    depends_on:
      - ghost-db
      - ghost-tunnel
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      url: ${DOMAIN}
      database__client: mysql
      database__connection__host: ghost-db
      database__connection__user: root
      database__connection__password: ${DB_PASSWORD}
      database__connection__database: ghost
      mail__transport: SMTP
      mail__from: ${POSTMASTER}
      mail__options__host: smtp.mailgun.org
      mail__options__port: 465
      mail__options__secure: true
      mail__options__auth__user: ${POSTMASTER}
      mail__options__auth__pass: ${SMTP_PASSWORD}
      # Tinybird analytics integration
      tinybird__tracker__endpoint: ${DOMAIN}/.ghost/analytics/api/v1/page_hit
      tinybird__tracker__datasource: analytics_events
      tinybird__adminToken: ${TINYBIRD_ADMIN_TOKEN:-}
      tinybird__workspaceId: ${TINYBIRD_WORKSPACE_ID:-}
      tinybird__stats__endpoint: ${TINYBIRD_API_URL:-https://api.tinybird.co}
      tinybird__tracker__token: ${TINYBIRD_TRACKER_TOKEN:-}
    volumes:
      - ghost-content:/var/lib/ghost/content
    networks:
      - ghost

  ghost-db:
    container_name: ghost-db
    image: mysql:8
    restart: always
    command: --mysql-native-password=ON
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "ghost-backup=stop"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ghost-db:/var/lib/mysql
    networks:
      - ghost

  ghost-tunnel:
    container_name: ghost-tunnel
    image: cloudflare/cloudflared
    restart: always
    command: tunnel --no-autoupdate run
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    networks:
      - ghost

  # ---------------------------------------------------------------------------
  # Traffic Analytics proxy (sits between browser and Tinybird)
  # Ghost injects ghost-stats.js which POSTs to /.ghost/analytics/api/v1/page_hit.
  # This service receives those events, enriches them, and forwards to Tinybird.
  # ---------------------------------------------------------------------------
  traffic-analytics:
    container_name: traffic-analytics
    image: ghost/traffic-analytics:1.0.85
    restart: always
    security_opt:
      - no-new-privileges:true
    expose:
      - "3000"
    volumes:
      - traffic-analytics-data:/data
    environment:
      NODE_ENV: production
      PROXY_TARGET: ${TINYBIRD_API_URL:-https://api.tinybird.co}/v0/events
      SALT_STORE_TYPE: ${SALT_STORE_TYPE:-file}
      SALT_STORE_FILE_PATH: /data/salts.json
      TINYBIRD_TRACKER_TOKEN: ${TINYBIRD_TRACKER_TOKEN:-}
      LOG_LEVEL: debug
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - ghost

  ghost-posse:
    container_name: ghost-posse
    image: wpowiertowski/posse:latest
    restart: always
    command: poetry run posse
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    mem_limit: 256m
    cpus: 0.5
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    volumes:
      - ./config.yml:/app/config.yml:ro
      - posse-interactions:/app/data
    secrets:
      - pushover_app_token
      - pushover_user_key
      - mastodon_personal_access_token
      - mastodon_behindtheviewfinder_access_token
      - bluesky_personal_app_password
      - bluesky_behindtheviewfinder_app_password
      - ghost_content_api_key
      - internal_api_token
    networks:
      - ghost

  ghost-backup:
    container_name: ghost-backup
    image: offen/docker-volume-backup:v2
    restart: always
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      BACKUP_CRON_EXPRESSION: "0 2 * * 0"
      BACKUP_FILENAME: "ghost-backup-%Y-%m-%dT%H-%M-%S.tar.gz"
      BACKUP_RETENTION_DAYS: "31"
      BACKUP_STOP_DURING_BACKUP_LABEL: "ghost-backup=stop"
      BACKUP_PRUNING_PREFIX: "ghost-backup-"
      DROPBOX_REFRESH_TOKEN_FILE: /run/secrets/dropbox_refresh_token
      DROPBOX_APP_KEY_FILE: /run/secrets/dropbox_app_key
      DROPBOX_APP_SECRET_FILE: /run/secrets/dropbox_app_secret
      DROPBOX_REMOTE_PATH: "/ghost-backups"
      DROPBOX_CONCURRENCY_LEVEL: "6"
    volumes:
      - ghost-content:/backup/ghost-content:ro
      - ghost-db:/backup/ghost-db:ro
      - ./backups:/archive
      - /var/run/docker.sock:/var/run/docker.sock:ro
    secrets:
      - dropbox_refresh_token
      - dropbox_app_key
      - dropbox_app_secret
    networks:
      - ghost

  ghost-caddy:
    container_name: ghost-caddy
    image: caddy:2-alpine
    restart: always
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    mem_limit: 128m
    cpus: 0.5
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - ghost

  # ---------------------------------------------------------------------------
  # Tinybird analytics one-shot services (profile: analytics)
  # Run these in order when setting up or upgrading Tinybird:
  #   docker compose run --rm tinybird-login
  #   docker compose run --rm tinybird-sync
  #   docker compose run --rm tinybird-deploy
  #   docker compose run --rm tinybird-login get-tokens  (to retrieve tokens)
  # ---------------------------------------------------------------------------

  tinybird-login:
    container_name: tinybird-login
    build:
      context: ./tinybird
      dockerfile: Dockerfile
    working_dir: /home/tinybird
    command: /usr/local/bin/tinybird-login
    volumes:
      - tinybird-home:/home/tinybird
      - tinybird-files:/data/tinybird
    profiles: [analytics]
    networks:
      - ghost
    tty: false
    restart: no

  tinybird-sync:
    container_name: tinybird-sync
    image: ghost:6
    command: >
      sh -c "
        if [ -d /var/lib/ghost/current/core/server/data/tinybird ]; then
          rm -rf /data/tinybird/*;
          cp -rf /var/lib/ghost/current/core/server/data/tinybird/* /data/tinybird/;
          echo 'Tinybird files synced into shared volume.';
        else
          echo 'Tinybird source directory not found in Ghost image.';
          exit 1;
        fi
      "
    volumes:
      - tinybird-files:/data/tinybird
    depends_on:
      tinybird-login:
        condition: service_completed_successfully
    profiles: [analytics]
    networks:
      - ghost
    restart: no

  tinybird-deploy:
    container_name: tinybird-deploy
    build:
      context: ./tinybird
      dockerfile: Dockerfile
    working_dir: /data/tinybird
    command: >
      sh -c "tb-wrapper --cloud deploy"
    volumes:
      - tinybird-home:/home/tinybird
      - tinybird-files:/data/tinybird
    depends_on:
      tinybird-sync:
        condition: service_completed_successfully
    profiles: [analytics]
    networks:
      - ghost
    tty: true
    restart: no

volumes:
  ghost-db:
    external: true
  ghost-content:
    external: true
  posse-interactions:
    external: true
  caddy-data:
    external: true
  caddy-config:
    external: true
  # Tinybird volumes (local, managed by compose)
  tinybird-home: {}
  tinybird-files: {}
  traffic-analytics-data: {}

networks:
  ghost:
    external: true

secrets:
  pushover_app_token:
    file: ./secrets/pushover_app_token.txt
  pushover_user_key:
    file: ./secrets/pushover_user_key.txt
  mastodon_personal_access_token:
    file: ./secrets/mastodon_personal_access_token.txt
  mastodon_behindtheviewfinder_access_token:
    file: ./secrets/mastodon_behindtheviewfinder_access_token.txt
  bluesky_personal_app_password:
    file: ./secrets/bluesky_personal_app_password.txt
  bluesky_behindtheviewfinder_app_password:
    file: ./secrets/bluesky_behindtheviewfinder_app_password.txt
  dropbox_refresh_token:
    file: ./secrets/dropbox_refresh_token.txt
  dropbox_app_key:
    file: ./secrets/dropbox_app_key.txt
  dropbox_app_secret:
    file: ./secrets/dropbox_app_secret.txt
  ghost_content_api_key:
    file: ./secrets/ghost_content_api_key.txt
  internal_api_token:
    file: ./secrets/internal_api_token.txt
  turnstile_secret:
    file: ./secrets/turnstile_secret.txt