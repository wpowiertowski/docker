name: ghost
services:

  ghost-server:
    image: ghost:6
    cap_add:
      - CAP_SYS_NICE
    restart: always
    depends_on:
      - ghost-db
      - ghost-tunnel
    environment:
      url: ${DOMAIN}
      database__client: mysql
      database__connection__host: ghost-db
      database__connection__user: root
      database__connection__password_FILE: /run/secrets/db_password
      database__connection__database: ghost
      mail__transport: SMTP 
      mail__from: ${POSTMASTER}
      mail__options__host: smtp.mailgun.org
      mail__options__port: 465
      mail__options__secure: true 
      mail__options__auth__user: ${POSTMASTER}
      mail__options__auth__pass_FILE: /run/secrets/smtp_password
    volumes:
      - ghost-content:/var/lib/ghost/content
    secrets:
      - db_password
      - smtp_password
    networks:
      - ghost

  ghost-db:
    image: mysql:8
    restart: always
    command: --mysql-native-password=ON
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_password
    volumes:
      - ghost-db:/var/lib/mysql
    secrets:
      - db_password
    networks:
      - ghost

  ghost-tunnel:
    container_name: cloudflared-tunnel
    image: cloudflare/cloudflared
    restart: always
    entrypoint: ["/bin/sh", "-c"]
    command: ["export TUNNEL_TOKEN=$$(cat /run/secrets/tunnel_token) && cloudflared tunnel --no-autoupdate run"]
    secrets:
      - tunnel_token
    networks:
      - ghost

  ghost-posse:
    container_name: posse
    image: wpowiertowski/posse:latest
    restart: always
    command: poetry run posse
    volumes:
      - ./config.yml:/app/config.yml:ro
    secrets:
      - pushover_app_token
      - pushover_user_key
    networks:
      - ghost

volumes:
  ghost-db:
    external: true
  ghost-content:
    external: true

networks:
  ghost:
    external: true

# Docker secrets for sensitive credentials
# To use secrets:
# 1. Create secrets directory and secret files with your credentials:
#    mkdir -p secrets
#    printf '%s' 'YOUR_DB_PASSWORD' > secrets/db_password.txt
#    printf '%s' 'YOUR_SMTP_PASSWORD' > secrets/smtp_password.txt
#    printf '%s' 'YOUR_TUNNEL_TOKEN' > secrets/tunnel_token.txt
#    printf '%s' 'YOUR_PUSHOVER_APP_TOKEN' > secrets/pushover_app_token.txt
#    printf '%s' 'YOUR_PUSHOVER_USER_KEY' > secrets/pushover_user_key.txt
# 2. Ensure proper permissions: chmod 600 secrets/*.txt
secrets:
  db_password:
    file: ./secrets/db_password.txt
  smtp_password:
    file: ./secrets/smtp_password.txt
  tunnel_token:
    file: ./secrets/tunnel_token.txt
  pushover_app_token:
    file: ./secrets/pushover_app_token.txt
  pushover_user_key:
    file: ./secrets/pushover_user_key.txt
