name: watchtower
services:

  watchtower:
    # Using :latest tag to ensure Watchtower itself stays updated
    image: containrrr/watchtower:latest
    restart: always
    environment:
      # Check for updates every 24 hours (in seconds)
      WATCHTOWER_POLL_INTERVAL: 86400
      # Clean up old images after updating
      WATCHTOWER_CLEANUP: "true"
      # Include stopped containers in monitoring
      WATCHTOWER_INCLUDE_STOPPED: "true"
      # Run once and exit (set to false for continuous monitoring)
      WATCHTOWER_RUN_ONCE: "false"
      # Enable debug logging
      WATCHTOWER_DEBUG: "false"
      # Pushover notification settings (configure via .env file and secrets)
      # NOTE: Ensure WATCHTOWER_NOTIFICATION_URL is set in .env and secrets are created
      WATCHTOWER_NOTIFICATIONS: pushover
      WATCHTOWER_NOTIFICATION_URL: ${WATCHTOWER_NOTIFICATION_URL}
      WATCHTOWER_NOTIFICATION_PUSHOVER_USER_FILE: /run/secrets/pushover_user_key
      WATCHTOWER_NOTIFICATION_PUSHOVER_TOKEN_FILE: /run/secrets/pushover_app_token
    volumes:
      # Mount Docker socket to allow Watchtower to manage containers
      # NOTE: This grants full Docker daemon access - only use in trusted environments
      - /var/run/docker.sock:/var/run/docker.sock
    secrets:
      - pushover_user_key
      - pushover_app_token

# Docker secrets for Pushover credentials
# To use secrets:
# 1. Create secrets directory and secret files with your credentials:
#    mkdir -p secrets
#    printf '%s' 'YOUR_ACTUAL_APP_TOKEN_HERE' > secrets/pushover_app_token.txt
#    printf '%s' 'YOUR_ACTUAL_USER_KEY_HERE' > secrets/pushover_user_key.txt
# 2. Set WATCHTOWER_NOTIFICATION_URL in .env file (or leave as default)
secrets:
  pushover_app_token:
    file: ./secrets/pushover_app_token.txt
  pushover_user_key:
    file: ./secrets/pushover_user_key.txt
